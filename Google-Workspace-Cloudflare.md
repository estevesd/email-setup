# How to setup multiple domains on Google Workspace with Cloudflare for improved security
SPF, DKIM, DMARC, MTA-STS, TLS-RPT and even BIMI

# Google Workspace
1. [Add the domain to google](https://admin.google.com/u/0/ac/domains/manage?action_id=ADD_DOMAIN&journey=10) as a Secondary Domain
2. Take note of the generated TXT string 

## Cloudflare
1. Point NS to Cloudflare
2. Add the DNS entry generated by google for this domain

| Type | Name | Content | TTL |
| :--: | :--: | :-----: | :-: |
| TXT  | @ | google-site-verification=zt9gdr......EEq0QQ | Auto |

3. once verification is done, add more entries

| Type | Name     | Mail Server | TTL | Priority |
| :--: | :------: | :-------: | :---: | :-: |
| MX  | @ | aspmx.l.google.com | Auto | 1 |
| MX  | @ | alt1.aspmx.l.google.com | Auto | 5 |
| MX  | @ | alt2.aspmx.l.google.com | Auto | 5 |
| MX  | @ | alt3.aspmx.l.google.com | Auto | 10 |
| MX  | @ | alt4.aspmx.l.google.com | Auto | 10 |

## Google Workspace Admin
1. Go to your user [Directory > Users > [your user] > ADD ALTERNATE EMAILS](https://admin.google.com/ac/users)
2. add email aliases to user 

## Gmail
1. Add `New Label` : [domain.tld]
3. Go in [Settings(cog) > See all settings > Filters and Blocked Addresses > Create a new filter](https://mail.google.com/mail/u/0/#settings/filters)
4. To : [domain.tld]
5. `Create filter`
6. check `Apply the label '[domain.tld]'`
7. `Create filter`
8. add email account to [gmail inbox ](https://mail.google.com/mail/u/0/#settings/accounts)




# SPF
## Cloudflare
Go to `Websites > domain.tld > DNS > Add record`  

| Type | Name | Content | TTL |
| :--: | :--: | :-----: | :-: |
| TXT  | @ |  v=spf1 include:_spf.google.com ~all | Auto |




# DKIM
## Google Workspace Admin
1. Go to [Menu and then Apps > Google Workspace > Gmail > Authenticate email](https://admin.google.com/u/0/ac/apps/gmail/authenticateemail).
2. select the good domain
3. `Generate new record`
4. Copy the TXT record name

## Cloudflare
Go to `Websites > domain.tld > DNS > Add record`  

| Type | Name | Content | TTL |
| :--: | :--: | :-----: | :-: |
| TXT  | google._domainkey | v=DKIM1; k=rsa; p=MIIBIjANBgkqh......fQIDAQAB | Auto |





# DMARC
## Cloudflare
1. Go to `Websites > domain.tld > DNS > Add record`  

| Type | Name     | Content |
| :--: | :------: | :-------: |
| TXT  | _dmarc | v=DMARC1;  p=reject; sp=reject; pct=100; rua=mailto:dmarc@[domain.tld]; ri=86400; aspf=s; adkim=s;  fo=1 |

- p(required): **DMARC Policy**. Can be set to `none`, `quarantined` or `reject`. "none," takes no action, it only helps collect DMARC reports. "quarantine" marks the failed emails as suspicious, while "reject" blocks them.
- sp (inherits from p): **subdomain policy**
- rua: **Aggregate report sending destination**.Skip to not receive reports
- ri: **Reporting Interval**. Defaults to 86400(once a day)
- aspf: **SPF alignment**. Allowed values are "r" (relaxed) or "s" (strict). "r" is the default, and allows a partial match, while the "s" tag requires the domains to be exactly the same
- adkim: **DKIM signature alignment**. Allowed values are "r" (relaxed) or "s" (strict). "r" is the default and allows a partial match, while the "s" tag requires the domains to be the same.
- fo: **Forensic report option**. Allowed values are "0," "1," "d," and "s." "0" is the default value, which generates a forensic report when both SPF and DKIM fail to produce an aligned pass. If either of the protocol outcome is something other than pass, use "1".
## Google Workspace Admin
1. Go to your user [Directory > Users > [your user] > ADD ALTERNATE EMAILS](https://admin.google.com/ac/users)

2. Add an email for the domain's dmarc reports dmarc@[domain.tld]

## Gmail
1. Add `New Label` : dmarc
2. Add sub label under dmarc : [domain-tld]
3. Go in [Settings(cog) > See all settings > Filters and Blocked Addresses > Create a new filter](https://mail.google.com/mail/u/0/#settings/filters)
4. To : dmarc@[domain.tld]
5. `Create filter`
6. check `Apply the label 'dmarc/[domain.tld]'`
7. `Create filter`




# MTA-STS
ref: https://developers.cloudflare.com/email-routing/setup/mta-sts/  
ref: https://365labs.cloud/blog/mta-sts-using-cloudflare-workers  
ref: https://dmarcly.com/blog/how-to-set-up-mta-sts-and-tls-reporting

## Cloudflare
1. Got to `Workers & Pages > Create > Choose MTA-STS`
2. Name it : `mta-sts-[domain].[tld]`  
3. Leave the code as is and `Deploy`
4. On the success page go to `Edit code`
5. Insert the following
```
const stsPolicies = {
  "mta-sts.[domain].[tld]":
`version: STSv1
mode: enforce
mx: aspmx.l.google.com
mx: alt1.aspmx.l.google.com
mx: alt2.aspmx.l.google.com
mx: alt3.aspmx.l.google.com
mx: alt4.aspmx.l.google.com
max_age: 86400`
}

const respHeaders = {
  "Content-Type": "text/plain;charset=UTF-8",
}

addEventListener("fetch", event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  let reqUrl = new URL(request.url)

  if (!stsPolicies.hasOwnProperty(reqUrl.hostname)) {
    return new Response(`${reqUrl.hostname} is not defined in the mta-sts worker\n`, {status: 500, headers: respHeaders})
  }

  if (reqUrl.protocol === "https:" && reqUrl.pathname === "/.well-known/mta-sts.txt") {
    return new Response(stsPolicies[reqUrl.hostname] + "\n", {status: 200, headers: respHeaders})
  } else {
    reqUrl.protocol = "https:"
    reqUrl.pathname = "/.well-known/mta-sts.txt"
    return Response.redirect(reqUrl, 301)
  }
}
```
6. Change `[domain].[tld]` to the correct domain
7. `mode` can be set to `none`, `testing` or `enforce`  
- `none`: the sending server treats the policy domain as though it does not have any active policy
- `testing`: the sending server delivers the message; if TLS reporting is implemented, the sending server also sends a TLS report to the specified email addresses indicating policy application failure, when the receiving host fails MX matching or certificate validation or does not support STARTTLS
- `enforce`: the sending server must not deliver the message to a receiving host that fails MX matching or certificate validation or that does not support STARTTLS
8. `Deploy`
9. Go back to the worker, and to `Settings > Triggers > Add Custom Domain`
10. Add `mta-sts.ezr.work` as Custom Domain
11. `Add Custom Domain`, this will add a new DNS entry
12. Check that the policy is in place
```
$ curl https://mta-sts.[domain].[tld]/.well-known/mta-sts.txt
version: STSv1
mode: enforce
mx: aspmx.l.google.com
mx: alt1.aspmx.l.google.com
mx: alt2.aspmx.l.google.com
mx: alt3.aspmx.l.google.com
mx: alt4.aspmx.l.google.com
max_age: 86400
```
13. Go to `Websites > domain.tld > DNS > Add record`  

| Type | Name     | Content |
| :--: | :------: | :-------: |
| TXT  | _mta-sts | v=STSv1; id=172673747170Z; |

The `id` value must be unique and changed every time you amend your MTA-STS policy.

14. MTA-STS lookup : https://easydmarc.com/tools/mta-sts-check?domain=[domain.tld]




# TLS-RPT
## Cloudflare
1. Go to `Websites > domain.tld > DNS > Add record`  

| Type | Name     | Content |
| :--: | :------: | :-------: |
| TXT  | _smtp._tls | v=TLSRPTv1; rua=mailto:tls-rpt@[domnain.tld]; |
2. TLS-RPT lookup : https://easydmarc.com/tools/tls-rpt-check?domain=[domain.tld]

## Google Workspace Admin
1. Go to your user ` Directory > Users > [your user] > ADD ALTERNATE EMAILS`
2. Add an email for the domain tls-rpt@[domain.tld]

## Gmail
1. Add `New Label` : tls-rpt
2. Add sub label under tls-rpt : [domain-tld]
3. Go in [Settings(cog) > See all settings > Filters and Blocked Addresses > Create a new filter](https://mail.google.com/mail/u/0/#settings/filters)
4. To : tls-rpt@[domain.tld]
5. `Create filter`
6. Check `Apply the label 'tls-rpt/[domain.tld]'`
7. `Create filter`




# BIMI
1. Prepare a logo in SVG : https://easydmarc.com/tools/bimi-logo-converter
2. It generates a file called `bimi-svg-tiny-12-ps.svg`
3. Put the file in a new empty folder on your computer

## Cloudflare
1. Got to `Workers & Pages > Create > Pages > Create using direct upload > Uplaod assets`
2. Name your project : `bimi-[domain]-[tld]`
3. Upload the folder containing the bimi file
4. `Deploy`
5. Go back to the worker, and to `Custom domains > Set up a Custom Domain`
6. Add `bimi.[domain.tld]`
7. `Activate domain`
8. Go to `Websites > domain.tld > DNS > Add record`  

| Type | Name     | Content |
| :--: | :------: | :-------: |
| TXT  | default._bimi | v=BIMI1;l=https://bimi.[domain.tld]/bimi-svg-tiny-12-ps.svg;a= |
9. BIMI lookup : https://easydmarc.com/tools/bimi-lookup?selector=default&domain=[domain.tld]




# RESULT
Your DNS ZONE should look like this
| Type | Name     | Content   | Proxy Status | TTL |
| :--: | :------: | :-------: | :----------: | :-: |
| A | * | IP.IP.IP.IP | DNS only | Auto |
| CNAME | bimi | bimi-[domain]-[tld].pages.dev | proxied | Auto |
| CNAME | www | [domain.tld] | DNS only | Auto |
| MX | [domain.tld] | alt4.aspmx.l.google.com | DNS only | 1 hr |
| MX | [domain.tld] | alt3.aspmx.l.google.com | DNS only | 1 hr |
| MX | [domain.tld] | alt2.aspmx.l.google.com | DNS only | 1 hr |
| MX | [domain.tld] | alt1.aspmx.l.google.com | DNS only | 1 hr |
| MX | [domain.tld] | aspmx.l.google.com | DNS only | 1 hr |
| TXT | default._bimi | v=BIMI1;l=https://bimi.[domain.tld]/bimi-svg-tiny-12-ps.svg;a= | DNS only | Auto |
| TXT | _dmarc | v=DMARC1;  p=reject; sp=reject; pct=100; rua=mailto:dmarc@[domain.tld]; ri=86400; aspf=s; adkim=s;  fo=1 | DNS only | Auto |
| TXT | [domain.tld] | v=spf1 include:_spf.google.com -all | DNS only | Auto |
| TXT | [domain.tld] | google-site-verification=iPK-7YH5q......4lBSKZSIVValXE | DNS only | Auto |
| TXT | google._domainkey | v=DKIM1; k=rsa; p=MIIBIjANB......IDAQAB | DNS only | Auto |
| TXT | _mta-sts_ | v=STSv1; id=172673540220Z | DNS only | Auto |
| TXT | _smtp._tls | v=TLSRPTv1; rua=mailto:tls-rpt@[domain-tld]; | DNS only | Auto |
| Worker | mta-sts.[domain-tld] | mta-sts-[domain]-[tld] | proxied | Auto |


# Google Admin Toolbox
Check that everything is working on google side https://toolbox.googleapps.com/apps/checkmx/check?&dkim_selector=&domain=[domain.tld]

# Thanks
[easyDMARC](https://easydmarc.com) for all the tools
